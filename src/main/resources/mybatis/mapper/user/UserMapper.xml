<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jindam.app.user.mapper.UserMapper">

    <!-- 사용자 테이블 조회 -->
    <sql id="getSelectUser">
        /*UserMapper.getSelectUser*/
        SELECT
            tu.uid
             ,tu.user_email
             ,tu.user_contact
             ,tu.user_name
             ,tu.user_nickname
             ,tu.user_status_code
             ,tu.user_gender_code
             ,tu.user_agg_code
             ,tu.user_type_code
             ,tu.user_brdt
             ,tu.user_join_type_code
             ,tu.push_token
             ,tu.last_login_at
             ,tu.bookmark_user_id_arr
             ,tu.interception_user_id_arr
             ,tu.prvcplc_agree_yn
             ,tu.terms_agree_yn
             ,tu.all_notification_reception_yn
             ,tu.all_notification_reception_at
             ,tu.notice_notification_reception_yn
             ,tu.notice_notification_reception_at
             ,tu.marketing_notification_reception_yn
             ,tu.marketing_notification_reception_at
             ,tu.offer_notification_reception_yn
             ,tu.offer_notification_reception_at
             ,tu.chat_notification_reception_yn
             ,tu.chat_notification_reception_at
             ,tu.position_addr
             ,tu.position_latt
             ,tu.position_lngt
             ,tu.position_distance
             ,tu.profile_photo_file_id
             ,tu.designer_appr_status_code
             ,tu.designer_introduce_content
             ,tu.designer_tag_arr
             ,tu.designer_work_status_code
             ,tu.designer_open_day_arr
             ,tu.designer_open_time_arr
             ,tu.designer_close_time_arr
             ,tu.designer_appointment_automatic_confirm_yn
             ,tu.designer_applink_url
             ,tu.designer_detail_photo_file_id
             ,tu.designer_account_brand_code
        FROM tb_user tu
    </sql>

    <select id="selectOneUserByUid" resultType="UserDetailResponseDto">
        /* UserMapper.selectOneUserByUid : 사용자 조회 */
        <include refid="getSelectUser" />
        <where>
            AND tu.uid = #{uid}
        </where>
    </select>

    <select id="selectOneUserByEmailAndUserJoinTypeCode" parameterType="UserDetailRequestDto" resultType="UserDetailResponseDto">
        /* UserMapper.selectOneUserByEmailAndUserJoinTypeCode : 사용자 조회. 이메일, 가입유형 */
        <include refid="getSelectUser" />
        <where>
            AND tu.user_email = #{userEmail}
            AND tu.user_join_type_code = #{userJoinTypeCode.name()}
        </where>
    </select>

    <insert id="insertUser" parameterType="UserDetailRequestDto">
        /* UserMapper.insertUser : 사용자 생성 */
        INSERT INTO tb_user (
                              uid
                            , user_email
                            , user_contact
                            , user_name
                            , user_nickname
                            , user_status_code
                            , user_gender_code
                            , user_agg_code
                            , user_type_code
                            , user_brdt
                            , user_join_type_code
                            , push_token
        ) VALUES (
                   #{uid}
                 , #{userEmail}
                 , #{userContact}
                 , #{userName}
                 , #{userNickname}
                 , #{userStatusCode.name()}
                 , #{userGenderCode.name()}
                 , #{userAggCode.name()}
                 , #{userTypeCoUde}
                 , #{userBrdt}
                 , NOW()
                 , #{pushToken}
                 )
    </insert>

    <update id="updateUser" parameterType="UserUpdateRequestDto">
        /* UserMapper.updateUser : 사용자 업데이트 */
        UPDATE tb_user
        <set>
            update_at = #{updateAt}
            , update_id = #{updateId}
            <if test="userEmail != null">
                , user_email = #{userEmail}
            </if>
            <if test="userContact != null">
                , user_contact = #{userContact}
            </if>
            <if test="userName != null">
                , user_name = #{userName}
            </if>
            <if test="userNickname != null">
                , user_nickname = #{userNickname}
            </if>
            <if test="userStatusCode != null">
                , user_status_code = #{userStatusCode.name()}
            </if>
            <if test="userGenderCode != null">
                , user_gender_code = #{userGenderCode.name()}
            </if>
            <if test="userAggCode != null">
                , user_agg_code = #{userAggCode.name()}
            </if>
            <if test="userTypeCode != null">
                , user_type_code = #{userTypeCode.name()}
            </if>
            <if test="userBrdt != null">
                , user_brdt = #{userBrdt}
            </if>
            <if test="userJoinTypeCode != null">
                , user_join_type_code = #{userJoinTypeCode.name()}
            </if>
            <if test="pushToken != null">
                , push_token = #{pushToken}
            </if>
            <if test="lastLoginAt != null">
                , last_login_at = #{lastLoginAt}
            </if>
            <if test="bookmarkUserIdArr != null and bookmarkUserIdArr.size() > 0">
                , bookmark_user_id_arr IN <foreach collection="bookmarkUserIdArr" item="id" open="(" separator=", " close=")">#{id}</foreach>
            </if>
            <if test="interceptionUserIdArr != null and interceptionUserIdArr.size() > 0">
                , interception_user_id_arr IN <foreach collection="interceptionUserIdArr" item="id" open="(" separator=", " close=")">#{id}</foreach>
            </if>
            <if test="prvcplcAgreeYn != null">
                , prvcplc_agree_yn = #{prvcplcAgreeYn}
            </if>
            <if test="termsAgreeYn != null">
                , terms_agree_yn = #{termsAgreeYn}
            </if>
            <if test="allNotificationReceptionYn != null">
                , all_notification_reception_yn = #{allNotificationReceptionYn}
            </if>
            <if test="allNotificationReceptionAt != null">
                , all_notification_reception_at = #{allNotificationReceptionAt}
            </if>
            <if test="noticeNotificationReceptionYn != null">
                , notice_notification_reception_yn = #{noticeNotificationReceptionYn}
            </if>
            <if test="noticeNotificationReceptionAt != null">
                , notice_notification_reception_at = #{noticeNotificationReceptionAt}
            </if>
            <if test="marketingNotificationReceptionYn != null">
                , marketing_notification_reception_yn = #{marketingNotificationReceptionYn}
            </if>
            <if test="marketingNotificationReceptionAt != null">
                , marketing_notification_reception_at = #{marketingNotificationReceptionAt}
            </if>
            <if test="offerNotificationReceptionYn != null">
                , offer_notification_reception_yn = #{offerNotificationReceptionYn}
            </if>
            <if test="offerNotificationReceptionAt != null">
                , offer_notification_reception_at = #{offerNotificationReceptionAt}
            </if>
            <if test="chatNotificationReceptionYn != null">
                , chat_notification_reception_yn = #{chatNotificationReceptionYn}
            </if>
            <if test="chatNotificationReceptionAt != null">
                , chat_notification_reception_at = #{chatNotificationReceptionAt}
            </if>
            <if test="positionAddr != null">
                , position_addr = #{positionAddr}
            </if>
            <if test="positionLatt != null">
                , position_latt = #{positionLatt}
            </if>
            <if test="positionLngt != null">
                , position_lngt = #{positionLngt}
            </if>
            <if test="positionDistance != null">
                , position_distance = #{positionDistance}
            </if>
            <if test="profilePhotoFileId != null">
                , profile_photo_file_id = #{profilePhotoFileId}
            </if>
            <if test="designerApprStatusCode != null">
                , designer_appr_status_code = #{designerApprStatusCode.name()}
            </if>
            <if test="designerIntroduceContent != null">
                , designer_introduce_content = #{designerIntroduceContent}
            </if>
            <if test="designerTagArr != null and designerTagArr.size() > 0">
                , designer_tag_arr IN <foreach collection="designerTagArr" item="id" open="(" separator=", " close=")">#{id}</foreach>
            </if>
            <if test="designerWorkStatusCode != null and designerWorkStatusCode.size() > 0">
                , designer_work_status_code = #{designerWorkStatusCode.name()}
            </if>
            <if test="designerOpenDayArr != null and designerOpenDayArr.size() > 0">
                , designer_open_day_arr IN <foreach collection="designerOpenDayArr" item="id" open="(" separator=", " close=")">#{id}</foreach>
            </if>
            <if test="designerOpenTimeArr != null and designerOpenTimeArr.size() > 0">
                , designer_open_time_arr IN <foreach collection="designerOpenTimeArr" item="id" open="(" separator=", " close=")">#{id}</foreach>
            </if>
            <if test="designerCloseTimeArr != null and designerCloseTimeArr.size() > 0">
                , designer_close_time_arr IN <foreach collection="designerCloseTimeArr" item="id" open="(" separator=", " close=")">#{id}</foreach>
            </if>
            <if test="designerAppointmentAutomaticConfirmYn != null">
                , designer_appointment_automatic_confirm_yn = #{designerAppointmentAutomaticConfirmYn}
            </if>
            <if test="designerApplinkUrl != null">
                , designer_applink_url = #{designerApplinkUrl}
            </if>
            <if test="designerDetailPhotoFileId != null">
                , designer_detail_photo_file_id = #{designerDetailPhotoFileId}
            </if>
            <if test="designerAccountBrandCode != null">
                , designer_account_brand_code = #{designerAccountBrandCode.name()}
            </if>
        </set>
        <where>
            AND uid = {uid}
        </where>
    </update>

    <update id="updateDesignerProfile" parameterType="UserUpdateRequestDto">
        /* UserMapper.updateDesignerProfile : 디자이너 프로필 업데이트 (PUT) */
        UPDATE tb_user
        <set>
            update_at = #{updateAt}
            , update_id = #{updateId}
            , user_name = #{userName}
            , profile_photo_file_id = #{profilePhotoFileId}
            , designer_introduce_content = #{designerIntroduceContent}
            , designer_open_day_arr = #{designerOpenDayArr}
            , designer_open_time_arr = #{designerOpenTimeArr}
            , designer_close_time_arr = #{designerCloseTimeArr}
            , designer_tag_arr = #{designerTagArr}
            , designer_appointment_automatic_confirm_yn = #{designerAppointmentAutomaticConfirmYn}
        </set>
        <where>
            AND uid = #{uid}
        </where>
    </update>
    

    <update id="deleteUser" parameterType="UserDeleteRequestDto">
        /*UserMapper.deleteUser*/
        UPDATE  tb_user
        <set>
            delete_yn = 'Y'
            delete_at =  NOW()
            delete_id = #{uid}
        </set>
        WHERE uid = #{uid}
    </update>

    <select id="loginUserByUid" parameterType="UserDetailRequestDto" resultType="UserDetailResponseDto">
        /*UserMapper.loginUserByUid*/
        SELECT
            tu.uid
             ,tu.user_email
             ,tu.user_contact
             ,tu.user_name
             ,tu.user_nickname
             ,tu.user_status_code
             ,tu.user_gender_code
             ,tu.user_agg_code
             ,tu.user_type_code
             ,tu.user_brdt
             ,tu.user_join_type_code
             ,tu.push_token
             ,tu.last_login_at
             ,tu.bookmark_user_id_arr
             ,tu.interception_user_id_arr
             ,tu.prvcplc_agree_yn
             ,tu.terms_agree_yn
             ,tu.all_notification_reception_yn
             ,tu.all_notification_reception_at
             ,tu.notice_notification_reception_yn
             ,tu.notice_notification_reception_at
             ,tu.marketing_notification_reception_yn
             ,tu.marketing_notification_reception_at
             ,tu.offer_notification_reception_yn
             ,tu.offer_notification_reception_at
             ,tu.chat_notification_reception_yn
             ,tu.chat_notification_reception_at
             ,tu.position_addr
             ,tu.position_latt
             ,tu.position_lngt
             ,tu.position_distance
             ,tu.profile_photo_file_id
             ,tu.designer_appr_status_code
             ,tu.designer_introduce_content
             ,tu.designer_tag_arr
             ,tu.designer_work_status_code
             ,tu.designer_open_day_arr
             ,tu.designer_open_time_arr
             ,tu.designer_close_time_arr
             ,tu.designer_appointment_automatic_confirm_yn
             ,tu.designer_applink_url
             ,tu.designer_detail_photo_file_id
             ,tu.designer_account_brand_code
        FROM tb_user tu
        WHERE 1=1
          AND  tu.uid = #{uid};
    </select>

    <update id="updateLastLoginByUid" parameterType="UserUpdateRequestDto">
        /*UserMapper.updateLastLoginByUid*/
        UPDATE tb_user
        <set>
            last_login_at = #{lastLoginAt}
        </set>
        <where>
            AND uid = #{uid}
        </where>
    </update>


    <!-- 검색 조건에 따른 디자이너 페이징 처리 후 목록 조회 -->
    <select id="selectListDesignerPaging" parameterType="UserDetailRequestDto" resultType="UserDetailResponseDto">
        /*UserMapper.selectListDesignerPaging*/
        SELECT
             tb.uid                     --사용자ID
            ,tb.user_email                      --사용자 이메일
            ,tb.user_contact                        --사용자 연락처
            ,tb.user_name                       --사용자 명
            ,tb.user_nickname                       --사용자 닉네임
            ,tb.user_status_code                        --사용자 상태 코드
            ,tb.user_gender_code                        --사용자 성별 코드
--             ,tb.user_agg_code                       --사용자 연령대 코드
--             ,tb.user_type_code                      --사용자 유형 코드
            ,tb.user_brdt                       --사용자 생년월일
            ,tb.user_join_type_code                     --사용자 가입 유형 코드
            ,tb.push_token                      --푸시 토큰
            ,tb.last_login_at                       --최종 로그인 일시
--             ,tb.bookmark_user_id_arr                        --즐겨찾기 사용자 ID 배열
            ,tb.interception_user_id_arr                        --차단 사용자 ID 배열
            ,tb.prvcplc_agree_yn                        --개인정보처리방침 동의 여부
            ,tb.terms_agree_yn                      --서비스 이용약관 동의 여부
            ,tb.all_notification_reception_yn                       --전체 알림 수신 여부
            ,tb.all_notification_reception_at                       --전체 알림 수신 일시
            ,tb.notice_notification_reception_yn                        --공지 알림 수신 여부
            ,tb.notice_notification_reception_at                        --공지 알림 수신 일시
            ,tb.marketing_notification_reception_yn                     --마케팅 알림 수신 여부
            ,tb.marketing_notification_reception_at                     --마케팅 알림 수신 일시
            ,tb.offer_notification_reception_yn                     --제안 알림 수신 여부
            ,tb.offer_notification_reception_at                     --제안 알림 수신 일시
            ,tb.chat_notification_reception_yn                      --채팅 알림 수신 여부
            ,tb.chat_notification_reception_at                      --채팅 알림 수신 일시
            ,tb.position_addr                       --위치 주소
            ,tb.position_latt                       --위치 위도
            ,tb.position_lngt                       --위치 경도
            ,tb.position_distance                       --위치 거리
            ,tb.profile_photo_file_id                       --프로필 사진 파일 ID
            ,tb.designer_appr_status_code                       --디자이너 승인 상태 코드
            ,tb.designer_introduce_content                      --디자이너 소개 내용
            ,tb.designer_tag_arr                        --디자이너 태그 배열
            ,tb.designer_work_status_code                       --디자이너 근무 상태 코드
            ,tb.designer_open_day_arr                       --디자이너 오픈 요일 배열
            ,tb.designer_open_time_arr                      --디자이너 오픈 시간 배열
            ,tb.designer_close_time_arr                     --디자이너 오프 시간 배열
            ,tb.designer_appointment_automatic_confirm_yn                       --디자이너 예약 자동 확정 여부
            ,tb.designer_applink_url                        --디자이너 앱링크 URL
            ,tb.designer_detail_photo_file_id                       --디자이너 세부 사진 파일 ID
            ,tb.designer_account_brand_code                     --디자이너 계좌 브랜드 코드
            ,tb.create_at                       --생성 일시
            ,tb.create_id                       --생성 ID
            ,tb.update_at                       --수정 일시
            ,tb.update_id                       --수정 ID
            ,tb.delete_yn                       --삭제 여부
            ,tb.delete_at                       --삭제 일시
            ,tb.delete_id                       --삭제 ID
        FROM tb_user tb

        <!--공통 조회 조건 -->
        <include refid="selectListDesignerPagingFrag"/>

        <!-- 정렬 조건 -->
        <trim prefix="ORDER BY" prefixOverrides=",">
            <foreach collection="sorts" item="sort" separator=",">
                <choose>
                    <when test="sort.name == 'createAt'">create_at <if test="sort.dir == 'desc'">DESC NULLS LAST</if></when>
                </choose>
            </foreach>
        </trim>
        <!-- 페이징 처리 -->
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!--조회조건에 따른 디자이너 목록 전체 카운트 조회 -->
    <select id="selectListDesignerPagingCount" parameterType="UserDetailRequestDto" resultType="int">
        /*UserMapper.selectListDesignerPagingCount*/
        SELECT
            count(*)
        FROM tb_user tb
        <!--공통 조회 조건 -->
        <include refid="selectListDesignerPagingFrag"/>
    </select>

    <sql id="selectListDesignerPagingFrag">
        <where>
            tb.delete_yn = 'N'
            <if test='userJoinTypeCode != null'>
                AND tb.user_join_type_code = #{userJoinTypeCode.name()}
            </if>
        </where>
    </sql>

    <select id="selectUserFavoriteCheck" parameterType="UserFavoriteDetailRequestDto" resultType="UserFavoriteDetailResponseDto">
        SELECT
            tub.user_bookmark_id,
            tub.uid,
            tub.bookmark_target_user_id,
            tub.user_gender_code,
            tub.user_agg_code,
            tub.user_type_code,
            tub.create_at,
            tub.create_id
        FROM tb_user_bookmark tub
        <where>
            AND tub.uid = #{uid}
            AND tub.bookmark_target_user_id = #{bookmarkTargetUserId}
            AND tub.delete_yn = 'N'
        </where>
    </select>

    <insert id="insertFavoriteUser" parameterType="UserFavoriteUpdateRequestDto">
        /*UserMapper.insertFavoriteDesigner*/
        INSERT INTO tb_user_bookmark  (
            user_bookmark_id,
            uid,
            bookmark_target_user_id,
            user_gender_code,
            user_agg_code,
            user_type_code,
            create_at,
            create_id
        ) VALUES (
            nextval('seq_tb_user_bookmark_user_bookmark_id'),
            #{uid}
            #{bookmarkTargetUserId}
            #{userGenderCode.name()}
            #{userAggCode.name()}
            #{userTypeCode.name()}
            #{workAt}
            #{workId}
                         )
    </insert>

    <update id="updateFavoriteUser" parameterType="UserFavoriteUpdateRequestDto">
        /*UserMapper.updateFavoriteDesigner*/
        UPDATE tb_user_bookmark
        <set>
            <if test="userGenderCode != null">user_gender_code = #{userGenderCode.name()},</if>
            <if test="userAggCode != null">user_agg_code = #{userAggCode.name()},</if>
            <if test="userTypeCode != null">user_type_code = #{userTypeCode.name()},</if>
            <if test="updateAt">update_at = #{workAt},</if>
            <if test="updateId">update_id = #{workId},</if>
            delete_yn =#{deleteYn},
        </set>
        <where>
            uid = #{uid},
            bookmark_target_user_id = #{bookmarkTargetUserId}
        </where>
    </update>

    <!-- 검색 조건에 따른 목록 페이징 처리 후 목록 조회 -->
    <select id="selectUserFavoriteByUidPaging" parameterType="UserFavoriteDetailRequestDto" resultType="UserFavoriteDetailResponseDto">
        /*UserMapper.selectUserFavoriteByUidPaging*/
        SELECT
            tb.user_bookmark_id,
            tb.uid,
            tb.bookmark_target_user_id,
            tb.user_gender_code,
            tb.user_agg_code,
            tb.user_type_code,
            tb.create_at,
            tb.create_id,
        FROM tb_user_bookmark tb

        <!--공통 조회 조건 -->
        <include refid="selectUserFavoriteByUidFrag"/>

        <!-- 정렬 조건 -->
        <trim prefix="ORDER BY" prefixOverrides=",">
            <foreach collection="sorts" item="sort" separator=",">
                <choose>
                    <when test="sort.name == 'createAt'">create_at <if test="sort.dir == 'desc'">DESC NULLS LAST</if></when>
                </choose>
            </foreach>
        </trim>

        <!-- 페이징 처리 -->
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!--조회조건에 따른 디자이너 목록 전체 카운트 조회 -->
    <select id="selectUserFavoriteByUidPagingCount" parameterType="UserFavoriteDetailRequestDto" resultType="int">
        /*UserMapper.selectUserFavoriteByUidPagingCount*/
        SELECT
        count(*)
        FROM tb_user_bookmark tb
        <!--공통 조회 조건 -->
        <include refid="selectUserFavoriteByUidFrag"/>
    </select>

    <sql id="selectUserFavoriteByUidFrag">
        <where>
            tb.delete_yn = 'N'
            <if test='uid != null'>
                AND tb.uid = #{uid}
            </if>
        </where>
    </sql>

</mapper>