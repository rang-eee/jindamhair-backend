<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jindam.app.notification.mapper.ChatMapper">
    <insert id="selectChatRoomByUserId" parameterType="ChatInsertRequestDto">
        /*Chatmapper.selectChatRoomByUserId*/
        SELECT
            chatroom_member_id
            chatroom_id
            uid
            chatroom_name
        FROM
            (SELECT
                 *
             FROM tb_chatroom_member
             WHERE uid = #{writeUid} AND delete_yn = 'N' AND delete_at IS null AND delete_id IS NULL) me
                JOIN (SELECT * FROM tb_chatroom_member
                      WHERE uid = #{receiverId} AND delete_yn = 'N' AND delete_at IS null AND delete_id IS NULL) trg
                ON me.chatroom_id = trg.chatroom_id
    </insert>

    <insert id="insertChatRoom" parameterType="ChatInsertRequestDto">
        /*Chatmapper.insertChatRoom*/
        INSERT INTO tb_chatroom (
            chatroom_id
            create_at
            create_id
        ) VALUES (
             nextval('seq_tb_chatroom'),
             now(),
             #{writeUid}
           )

    </insert>

    <!-- 검색 조건에 따른 채팅방 페이징 처리 후 목록 조회 -->
    <select id="selectChatRoomPaging" parameterType="ChatRoomDetailRequestDto" resultType="ChatRoomMemberResponseDto">
        /*Chatmapper.selectChatRoomPaging*/
        SELECT
            tb.chatroom_member_id,
            tb.chatroom_id,
            tb.uid,
            tb.chatroom_name,
            tb.last_read_at,
            tb.create_at
        FROM tb_chatroom_member tb

        <!--공통 조회 조건 -->
        <include refid="selectChatRoomPagingFrag"/>

        <!-- 정렬 조건 -->
        <trim prefix="ORDER BY" prefixOverrides=",">
            <foreach collection="sorts" item="sort" separator=",">
                <choose>
                    <when test="sort.name == 'createAt'">create_at <if test="sort.dir == 'desc'">DESC NULLS LAST</if></when>
                </choose>
            </foreach>
        </trim>

        <!-- 페이징 처리 -->
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!--조회조건에 따른 디자이너 목록 전체 카운트 조회 -->
    <select id="selectChatRoomPagingCount" parameterType="ChatRoomDetailRequestDto" resultType="int">
        /*Chatmapper.selectChatRoomPagingCount*/
        SELECT
        count(*)
        FROM tb_chatroom_member tb
        <!--공통 조회 조건 -->
        <include refid="selectChatRoomPagingFrag"/>
    </select>

    <sql id="selectChatRoomPagingFrag">
        <where>
            tb.delete_yn = 'N'
            <if test='uid != null'>
                AND tb.uid = #{uid}
            </if>
        </where>
    </sql>


</mapper>